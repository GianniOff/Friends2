<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Navigator v8 | Profile Dashboard</title>
    <style>
        :root { --bg: #030508; --card: #0d1117; --accent: #3b82f6; --text: #f0f6fc; --danger: #f85149; }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; overflow-x: hidden; }
        
        /* Navigation */
        .navbar { display: flex; justify-content: space-between; align-items: center; padding: 15px 40px; background: rgba(13,17,23,0.8); backdrop-filter: blur(10px); border-bottom: 1px solid #30363d; position: sticky; top: 0; z-index: 100; }
        
        /* Liste Publique */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; padding: 40px; }
        .public-card { background: var(--card); border: 1px solid #30363d; padding: 40px 20px; border-radius: 12px; text-align: center; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
        .public-card:hover { border-color: var(--accent); transform: translateY(-5px); box-shadow: 0 8px 24px rgba(59,130,246,0.2); }
        .id-badge { font-family: "SF Mono", monospace; color: var(--accent); font-size: 1.3rem; letter-spacing: 1px; }

        /* PAGE PROFIL PLEIN √âCRAN */
        #profile-page { position: fixed; inset: 0; background: var(--bg); z-index: 200; display: none; overflow-y: auto; padding-bottom: 50px; }
        .page-content { max-width: 900px; margin: 0 auto; padding: 60px 20px; }
        .back-btn { background: none; border: 1px solid #30363d; color: #8b949e; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-bottom: 30px; transition: 0.2s; }
        .back-btn:hover { border-color: var(--text); color: var(--text); }

        /* Mise en page Profil */
        .header-section { display: flex; gap: 40px; align-items: flex-start; margin-bottom: 40px; }
        .big-avatar { width: 180px; height: 180px; border-radius: 20px; object-fit: cover; border: 2px solid #30363d; background: #161b22; }
        .main-info h1 { font-size: 2.5rem; margin: 0 0 10px 0; letter-spacing: -1px; }
        .info-pill { background: #1f2937; color: var(--accent); padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; margin-right: 8px; }

        /* Configuration Admin */
        .admin-box { background: #161b22; border: 1px dashed #30363d; padding: 30px; border-radius: 12px; margin-top: 40px; }
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        label { display: block; font-size: 11px; color: #8b949e; text-transform: uppercase; margin-bottom: 8px; }
        input, select, textarea { width: 100%; background: #0d1117; border: 1px solid #30363d; color: white; padding: 12px; border-radius: 8px; box-sizing: border-box; }
        
        .btn { padding: 12px 24px; border-radius: 8px; font-weight: bold; cursor: pointer; border: none; }
        .btn-save { background: var(--accent); color: white; width: 100%; margin-top: 20px; }

        .stat-bar-container { margin-top: 20px; }
        .stat-label { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 5px; }
        .stat-bg { background: #30363d; height: 8px; border-radius: 4px; overflow: hidden; }
        .stat-fill { background: var(--accent); height: 100%; border-radius: 4px; transition: width 1s; }
    </style>
</head>
<body>

<div class="navbar">
    <div style="font-weight: 900; color: var(--accent); font-size: 1.5rem; letter-spacing: -1px;">NAVIGATOR <span style="color:white; font-weight:200">v8</span></div>
    <div style="display:flex; gap:15px;">
        <button id="btn-new" onclick="openNew()" style="display:none; background:var(--accent); color:white; border:none; padding:10px 20px; border-radius:8px; font-weight:bold; cursor:pointer;">+ Cr√©er Dossier</button>
        <button id="admin-btn" onclick="askAdmin()" style="background:none; border:1px solid #30363d; color:white; cursor:pointer; padding:10px 20px; border-radius:8px;">Mode Admin</button>
    </div>
</div>

<div class="grid" id="main-grid"></div>

<div id="profile-page">
    <div class="page-content">
        <button class="back-btn" onclick="closeProfile()">‚Üê Retour √† la liste</button>
        
        <div id="view-mode">
            <div class="header-section">
                <img id="v-avatar" class="big-avatar">
                <div class="main-info">
                    <div id="v-status" style="font-size:12px; color:var(--accent); margin-bottom:5px; font-weight:bold; text-transform:uppercase;"></div>
                    <h1 id="v-name"></h1>
                    <div id="v-pills" style="margin-bottom:20px;"></div>
                    <div style="display:flex; gap:30px; border-top:1px solid #30363d; padding-top:20px;">
                        <div><label>Profession</label><div id="v-job"></div></div>
                        <div><label>Localisation</label><div id="v-loc"></div></div>
                        <div><label>Menace</label><div id="v-level"></div></div>
                    </div>
                </div>
            </div>

            <div style="display:grid; grid-template-columns: 2fr 1fr; gap:40px;">
                <div>
                    <label>Biographie & Notes</label>
                    <div id="v-bio" style="background:#0d1117; padding:20px; border-radius:12px; line-height:1.6; border:1px solid #30363d;"></div>
                </div>
                <div>
                    <label>Statistiques</label>
                    <div id="v-stats"></div>
                </div>
            </div>
        </div>

        <div id="admin-editor" class="admin-box" style="display:none;">
            <h2 style="margin-top:0">üõ† Configuration du Dossier</h2>
            <div class="input-grid">
                <div><label>ID Dossier (Unique)</label><input type="text" id="ed-id"></div>
                <div><label>Mot de Passe Dossier</label><input type="text" id="ed-pass"></div>
                <div><label>Pr√©nom</label><input type="text" id="ed-prenom"></div>
                <div><label>Nom</label><input type="text" id="ed-nom"></div>
                <div><label>Profession</label><input type="text" id="ed-job"></div>
                <div><label>Localisation</label><input type="text" id="ed-loc"></div>
            </div>
            
            <div class="input-grid" style="margin-top:20px;">
                <div>
                    <label>Niveau / Risque</label>
                    <select id="ed-level">
                        <option>Alpha (Faible)</option>
                        <option>B√™ta (Moyen)</option>
                        <option>Gamma (√âlev√©)</option>
                        <option>Om√©ga (Critique)</option>
                    </select>
                </div>
                <div>
                    <label>Statut</label>
                    <select id="ed-status">
                        <option>Op√©rationnel</option>
                        <option>En Attente</option>
                        <option>Archiv√©</option>
                    </select>
                </div>
            </div>

            <div style="margin-top:20px;">
                <label>Avatar URL</label>
                <input type="text" id="ed-avatar">
            </div>

            <div style="margin-top:20px;">
                <label>Notes Bio</label>
                <textarea id="ed-bio" rows="6"></textarea>
            </div>

            <div style="margin-top:20px;">
                <div style="display:flex; justify-content:space-between"><b>STATISTIQUES</b> <button onclick="addStatRow()">+ Ajouter</button></div>
                <div id="ed-stats-area" style="margin-top:10px;"></div>
            </div>

            <button class="btn btn-save" onclick="save()">üíæ Sauvegarder les modifications</button>
            <button class="btn" onclick="remove()" style="background:var(--danger); color:white; width:100%; margin-top:10px;">Supprimer le dossier</button>
        </div>
    </div>
</div>

<script>
    const API = "https://economically-pseudoetymological-serenity.ngrok-free.dev";
    let ADMIN_CODE = "";

    async function loadPublic() {
        const r = await fetch(`${API}/public_list`, { headers: {"ngrok-skip-browser-warning":"1"} });
        const ids = await r.json();
        const grid = document.getElementById('main-grid');
        grid.innerHTML = ids.map(id => `
            <div class="public-card" onclick="openProfile('${id}')">
                <div class="id-badge">${id}</div>
                <div style="font-size:10px; margin-top:15px; color:#8b949e; font-weight:bold;">DOSSIER S√âCURIS√â</div>
            </div>
        `).join('');
    }

    async function openProfile(id) {
        let pass = "";
        // Si pas admin, on demande le pass du profil
        if(!ADMIN_CODE) {
            pass = prompt(`Entrez le code d'acc√®s pour [${id}] :`);
            if(!pass) return;
        }

        const r = await fetch(`${API}/get_details`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', "ngrok-skip-browser-warning":"1"},
            body: JSON.stringify({id: id, password: pass, admin_code: ADMIN_CODE}) // On envoie les deux
        });

        if(r.ok) {
            const data = await r.json();
            renderProfile(data);
        } else {
            alert("Acc√®s refus√©.");
        }
    }

    function renderProfile(d) {
        document.getElementById('profile-page').style.display = "block";
        document.body.style.overflow = "hidden";

        // Vue Publique
        document.getElementById('v-avatar').src = d.avatar || "https://via.placeholder.com/180";
        document.getElementById('v-name').innerText = `${d.prenom} ${d.nom}`;
        document.getElementById('v-status').innerText = d.status;
        document.getElementById('v-job').innerText = d.profession || "Non renseign√©";
        document.getElementById('v-loc').innerText = d.localisation || "Inconnue";
        document.getElementById('v-level').innerText = d.niveau || "Alpha";
        document.getElementById('v-bio').innerText = d.bio || "Aucune note disponible.";
        document.getElementById('v-pills').innerHTML = d.categories.map(c => `<span class="info-pill">${c}</span>`).join('');
        
        let sHtml = "";
        Object.entries(d.stats).forEach(([k,v]) => {
            sHtml += `
                <div class="stat-bar-container">
                    <div class="stat-label"><span>${k}</span><span>${v}%</span></div>
                    <div class="stat-bg"><div class="stat-fill" style="width:${v}%"></div></div>
                </div>`;
        });
        document.getElementById('v-stats').innerHTML = sHtml;

        // Mode Admin
        if(ADMIN_CODE) {
            document.getElementById('admin-editor').style.display = "block";
            document.getElementById('ed-id').value = d.id;
            document.getElementById('ed-id').disabled = true;
            document.getElementById('ed-prenom').value = d.prenom;
            document.getElementById('ed-nom').value = d.nom;
            document.getElementById('ed-pass').value = d.password;
            document.getElementById('ed-job').value = d.profession || "";
            document.getElementById('ed-loc').value = d.localisation || "";
            document.getElementById('ed-level').value = d.niveau || "Alpha (Faible)";
            document.getElementById('ed-status').value = d.status || "Op√©rationnel";
            document.getElementById('ed-avatar').value = d.avatar || "";
            document.getElementById('ed-bio').value = d.bio || "";
            document.getElementById('ed-stats-area').innerHTML = "";
            Object.entries(d.stats).forEach(([k,v]) => addStatRow(k,v));
        } else {
            document.getElementById('admin-editor').style.display = "none";
        }
    }

    function openNew() {
        renderProfile({id:"", prenom:"", nom:"", categories:[], status:"Op√©rationnel", bio:"", avatar:"", stats:{"Loyaut√©":50}, profession:"", localisation:"", niveau:"Alpha", password:""});
        document.getElementById('ed-id').disabled = false;
    }

    function addStatRow(k="", v=50) {
        const div = document.createElement('div');
        div.className = "stat-input-row";
        div.style = "display:flex; gap:10px; margin-bottom:10px;";
        div.innerHTML = `<input type="text" value="${k}" class="sk" placeholder="Statut" style="flex:2">
                         <input type="number" value="${v}" class="sv" style="flex:1">`;
        document.getElementById('ed-stats-area').appendChild(div);
    }

    async function save() {
        const stats = {};
        document.querySelectorAll('.stat-input-row').forEach(row => {
            const k = row.querySelector('.sk').value;
            const v = row.querySelector('.sv').value;
            if(k) stats[k] = parseInt(v);
        });

        const p = {
            id: document.getElementById('ed-id').value,
            prenom: document.getElementById('ed-prenom').value,
            nom: document.getElementById('ed-nom').value,
            categories: ["Membre"], // Tu peux rajouter des checkbox si tu veux
            status: document.getElementById('ed-status').value,
            bio: document.getElementById('ed-bio').value,
            avatar: document.getElementById('ed-avatar').value,
            stats: stats, profile_pass: document.getElementById('ed-pass').value,
            profession: document.getElementById('ed-job').value,
            localisation: document.getElementById('ed-loc').value,
            niveau: document.getElementById('ed-level').value,
            admin_code: ADMIN_CODE
        };

        await fetch(`${API}/update`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', "ngrok-skip-browser-warning":"1"},
            body: JSON.stringify(p)
        });
        closeProfile(); loadPublic();
    }

    async function remove() {
        if(!confirm("Supprimer ce dossier ?")) return;
        await fetch(`${API}/delete`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', "ngrok-skip-browser-warning":"1"},
            body: JSON.stringify({id: document.getElementById('ed-id').value, code: ADMIN_CODE})
        });
        closeProfile(); loadPublic();
    }

    function askAdmin() {
        const p = prompt("Code Admin :");
        if(p === "ExpA22") {
            ADMIN_CODE = p;
            document.getElementById('admin-btn').innerText = "Admin ‚úÖ";
            document.getElementById('btn-new').style.display = "block";
            alert("Mode Admin d√©bloqu√©. Acc√®s illimit√© aux dossiers activ√©.");
        }
    }

    function closeProfile() {
        document.getElementById('profile-page').style.display = "none";
        document.body.style.overflow = "auto";
    }

    loadPublic();
</script>
</body>
</html>
