<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Navigator | Enterprise</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0f172a; --surf: #1e293b; --prim: #38bdf8; --txt: #f1f5f9; }
        body { background: var(--bg); color: var(--txt); font-family: 'Inter', sans-serif; margin: 0; }
        header { display: flex; justify-content: space-between; padding: 20px 40px; border-bottom: 1px solid #334155; align-items: center; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; padding: 40px; }
        .card { background: var(--surf); padding: 20px; border-radius: 12px; border: 1px solid #334155; cursor: pointer; }
        .stat-bar { height: 6px; background: #334155; border-radius: 3px; margin: 5px 0 10px 0; overflow: hidden; }
        .stat-fill { height: 100%; background: var(--prim); transition: 0.3s; }
        #editor { position: fixed; right: -500px; top: 0; width: 400px; height: 100%; background: var(--surf); padding: 30px; transition: 0.4s; z-index: 1000; overflow-y: auto; border-left: 2px solid var(--prim); }
        #editor.open { right: 0; }
        input, textarea, select { width: 100%; padding: 10px; margin: 10px 0; background: #0f172a; border: 1px solid #334155; color: white; border-radius: 6px; }
        .btn { padding: 10px 20px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; }
        .btn-prim { background: var(--prim); color: #0f172a; }
        #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; }
    </style>
</head>
<body>

<header>
    <div style="font-weight:800; font-size:1.5rem;">NAVIGATOR</div>
    <div style="display:flex; gap:10px;">
        <button class="btn btn-prim" id="add-btn" style="display:none" onclick="openEditor(null)">+ Nouveau</button>
        <button class="btn" onclick="auth()" id="auth-btn">Connexion</button>
    </div>
</header>

<div class="grid" id="grid"></div>

<div id="overlay" onclick="closeEditor()"></div>
<div id="editor">
    <h2 id="edit-title">Dossier</h2>
    <input type="text" id="ed-id" placeholder="ID Unique">
    <input type="text" id="ed-prenom" placeholder="Prénom">
    <input type="text" id="ed-nom" placeholder="Nom">
    <select id="ed-cat"><option>Personnel</option><option>Professionnel</option><option>VIP</option></select>
    <textarea id="ed-bio" placeholder="Notes/Biographie"></textarea>
    
    <div style="display:flex; justify-content:space-between; margin-top:20px;">
        <strong>Stats</strong>
        <button class="btn" style="font-size:10px;" onclick="addStatRow()">+ Ajouter</button>
    </div>
    <div id="stats-area"></div>

    <button class="btn btn-prim" style="width:100%; margin-top:20px;" onclick="save()">Enregistrer</button>
    <button class="btn" style="width:100%; margin-top:10px; background:red;" id="del-btn" onclick="remove()">Supprimer</button>
</div>

<script>
    // METS TA NOUVELLE URL NGROK ICI
    const API_URL = "https://economically-pseudoetymological-serenity.ngrok-free.dev";
    let DATA = {};
    let TOKEN = "";

    async function load() {
        try {
            const r = await fetch(`${API_URL}/data`, { headers: {"ngrok-skip-browser-warning":"1"} });
            DATA = await r.json();
            render();
        } catch(e) { console.error("Erreur de chargement"); }
    }

    function render() {
        const g = document.getElementById('grid');
        g.innerHTML = "";
        Object.entries(DATA).forEach(([id, info]) => {
            let sHtml = "";
            Object.entries(info.stats).forEach(([k,v]) => {
                sHtml += `<div style="font-size:11px">${k} (${v}%)</div><div class="stat-bar"><div class="stat-fill" style="width:${v}%"></div></div>`;
            });
            g.innerHTML += `
                <div class="card" onclick="openEditor('${id}')">
                    <div style="font-weight:bold; font-size:1.2rem">${info.prenom} ${info.nom}</div>
                    <div style="color:var(--prim); font-size:12px; margin-bottom:10px">${info.category}</div>
                    <div style="font-size:13px; color:#94a3b8; margin-bottom:15px">${info.bio}</div>
                    ${sHtml}
                </div>`;
        });
    }

    function openEditor(id) {
        if(!TOKEN) return alert("Connectez-vous d'abord");
        document.getElementById('editor').classList.add('open');
        document.getElementById('overlay').style.display = "block";
        const area = document.getElementById('stats-area');
        area.innerHTML = "";

        if(id) {
            const item = DATA[id];
            document.getElementById('ed-id').value = id;
            document.getElementById('ed-id').disabled = true;
            document.getElementById('ed-prenom').value = item.prenom;
            document.getElementById('ed-nom').value = item.nom;
            document.getElementById('ed-cat').value = item.category;
            document.getElementById('ed-bio').value = item.bio;
            Object.entries(item.stats).forEach(([k,v]) => addStatRow(k,v));
            document.getElementById('del-btn').style.display = "block";
        } else {
            document.getElementById('ed-id').value = "";
            document.getElementById('ed-id').disabled = false;
            document.getElementById('ed-prenom').value = "";
            document.getElementById('ed-nom').value = "";
            addStatRow("Loyauté", 50);
            document.getElementById('del-btn').style.display = "none";
        }
    }

    function addStatRow(n="", v=50) {
        const d = document.createElement('div');
        d.className = "st-row";
        d.innerHTML = `<div style="display:flex; gap:5px"><input type="text" value="${n}" class="sn" style="flex:2"><input type="number" value="${v}" class="sv" style="flex:1"></div>`;
        document.getElementById('stats-area').appendChild(d);
    }

    async function save() {
        const stats = {};
        document.querySelectorAll('.st-row').forEach(r => {
            const n = r.querySelector('.sn').value;
            const v = r.querySelector('.sv').value;
            if(n) stats[n] = parseInt(v);
        });

        const p = {
            ami_id: document.getElementById('ed-id').value,
            prenom: document.getElementById('ed-prenom').value,
            nom: document.getElementById('ed-nom').value,
            dob: "N/A", bio: document.getElementById('ed-bio').value,
            category: document.getElementById('ed-cat').value,
            stats: stats, access_code: TOKEN
        };

        await fetch(`${API_URL}/full_update`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(p)
        });
        closeEditor(); load();
    }

    async function remove() {
        if(!confirm("Supprimer ?")) return;
        await fetch(`${API_URL}/delete`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ami_id: document.getElementById('ed-id').value, access_code: TOKEN})
        });
        closeEditor(); load();
    }

    function auth() {
        const p = prompt("Code :");
        if(p === "ExpA22") {
            TOKEN = p;
            document.getElementById('auth-btn').innerText = "Admin ✅";
            document.getElementById('add-btn').style.display = "block";
        }
    }

    function closeEditor() {
        document.getElementById('editor').classList.remove('open');
        document.getElementById('overlay').style.display = "none";
    }

    load();
    setInterval(load, 15000);
</script>
</body>
</html>
